---
import { getCollection } from "astro:content";
import Posts from "@components/blog/posts.astro";
import Container from "@components/container.astro";
import Sectionhead from "@components/sectionhead.astro";
import Layout from "@layouts/Layout.astro";

import { getLangFromUrl, useTranslations } from "../i18n/utils";

// Get all blog posts for English
const posts = await getCollection("blog", ({ data }) => {
	return !data.draft;
});

// Process posts to extract language and clean slugs
const processedPosts = posts.map((post) => {
	const slugParts = post.slug.split("/");
	let lang = "en"; // Default to English
	
	// If the slug starts with a language code, extract it
	if (slugParts.length > 1) {
		lang = slugParts[0];
	}
	
	// Remove language prefix from slug for the final slug
	const finalSlug = slugParts.length > 1 ? slugParts.slice(1).join("/") : post.slug;
	
	return {
		...post,
		slug: finalSlug,
		lang: lang,
	};
});

// Filter for English posts only
const localizedPosts = processedPosts.filter(
	(post) => post.lang === "en",
);

// Sort by publish date (newest first)
localizedPosts.sort(
	(a, b) => b.data.publishDate.valueOf() - a.data.publishDate.valueOf(),
);

// Take first 4 posts for the main page
const recentPosts = localizedPosts.slice(0, 4);

// Get current language and create translation function
const safeUrl = Astro.url || new URL('/', Astro.site || 'http://localhost:4321');
const lang = getLangFromUrl(safeUrl);
const t = useTranslations(lang);
---

<Layout title="Blog">
	<Container>
		<Sectionhead>
			<Fragment slot="title">Our Blog</Fragment>
			<Fragment slot="desc">Discover Industry Insights, Company News, and Expert Opinions.</Fragment>
		</Sectionhead>
		<Posts posts={recentPosts} />
		
		{localizedPosts.length > 4 && (
			<div class="flex justify-center mt-20">
				<a 
					href="/blog/1" 
					class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors"
				>
					View All Posts
				</a>
			</div>
		)}
	</Container>
</Layout>
